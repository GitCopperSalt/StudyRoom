name: Dependency Update

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è‡ªåŠ¨æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'
        
    - name: è¿è¡Œnpm outdated
      run: |
        cd client_admin && npm outdated
        cd ../client_home && npm outdated
        
    - name: è‡ªåŠ¨åˆ›å»ºPRæ›´æ–°ä¾èµ–
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          // æ£€æŸ¥client_admin
          console.log('æ£€æŸ¥client_adminä¾èµ–...');
          try {
            execSync('cd client_admin && npm update', { stdio: 'inherit' });
            console.log('client_adminä¾èµ–å·²æ›´æ–°');
          } catch (error) {
            console.log('client_adminä¾èµ–æ›´æ–°å¤±è´¥:', error.message);
          }
          
          // æ£€æŸ¥client_home
          console.log('æ£€æŸ¥client_homeä¾èµ–...');
          try {
            execSync('cd client_home && npm update', { stdio: 'inherit' });
            console.log('client_homeä¾èµ–å·²æ›´æ–°');
          } catch (error) {
            console.log('client_homeä¾èµ–æ›´æ–°å¤±è´¥:', error.message);
          }
          
          // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          const { execSync } = require('child_process');
          try {
            const status = execSync('git status --porcelain').toString();
            if (status) {
              console.log('æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œå°†åˆ›å»ºPR...');
              
              // åˆ›å»ºæ–°çš„åˆ†æ”¯
              execSync('git checkout -b dependency-update-' + new Date().toISOString().slice(0, 10));
              execSync('git add .');
              execSync('git commit -m "chore: æ›´æ–°npmä¾èµ–"');
              execSync('git push origin HEAD');
              
              // åˆ›å»ºPR
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”„ ä¾èµ–è‡ªåŠ¨æ›´æ–° - ' + new Date().toLocaleDateString(),
                head: 'dependency-update-' + new Date().toISOString().slice(0, 10),
                base: 'develop',
                body: 'è¿™ä¸ªPRè‡ªåŠ¨æ›´æ–°äº†npmä¾èµ–ã€‚\n\nè¯·æ£€æŸ¥æ›´æ”¹å¹¶ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚'
              });
              
              console.log('PRåˆ›å»ºæˆåŠŸ:', pr.data.html_url);
            } else {
              console.log('æ²¡æœ‰æ£€æµ‹åˆ°ä¾èµ–æ›´æ”¹');
            }
          } catch (error) {
            console.log('æ£€æŸ¥gitçŠ¶æ€å¤±è´¥:', error.message);
          }